version: '3.4'

x-app: &default-app
  build:
    context: "."
    args:
      - "RAILS_ENV=${RAILS_ENV:-development}"
  depends_on:
    - <%="#{app_name}-database"%>
    - <%="#{app_name}-redis"%>
  env_file:
    - ".env"
  restart: "${DOCKER_RESTART_POLICY:-unless-stopped}"
  stop_grace_period: "3s"
  stdin_open: true
  tty: true
  volumes:
    - .:/<%="#{app_name}_api"%>
    - <%="#{app_name}_bundler_gems"%>:/usr/local/bundle

services:
  <%="#{app_name}-database"%>:
    container_name: <%="#{app_name}-database"%>
    image: postgres:12.1
    env_file:
      - ".env"
    restart: "${DOCKER_RESTART_POLICY:-unless-stopped}"
    stop_grace_period: "3s"
    volumes:
      - <%="#{app_name}_data"%>:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql

  <%="#{app_name}-redis"%>:
    env_file:
      - ".env"
    image: "redis:6.2.6-bullseye"
    restart: "${DOCKER_RESTART_POLICY:-unless-stopped}"
    stop_grace_period: "3s"
    volumes:
      - "<%="#{app_name}_redis"%>:/data"


  <%="#{app_name}-api"%>:
    <<: *default-app
    container_name: <%="#{app_name}_api"%>
    ports:
      - "3010:3000"

  <%="#{app_name}-worker"%>:
    <<: *default-app
    container_name: <%="#{app_name}-worker"%>
    command: "bundle exec sidekiq -C config/sidekiq.yml"
    entrypoint: []

volumes:
  <%="#{app_name}_data"%>:
  <%="#{app_name}_bundler_gems"%>:
  <%="#{app_name}_redis"%>: